# 交易策略開發概覽

量化交易策略的開發可以從多個維度進行分類。傳統上，策略基於人類對市場的先驗知識和假設；而現代方法則更多地利用機器學習等數據驅動的工具來發現複雜模式。

## 一、 傳統量化策略分類

傳統策略通常基於明確的、由人設定的規則和經濟學或統計學假設。

### 1. 技術分析 (Technical Analysis)

-   **核心思想**: "市場行為包含一切信息"。假設所有資訊已反映在歷史價格和成交量中。
-   **方法**:
    -   **指標型**: 使用數學公式計算指標（如 MA, RSI, MACD）來產生信號。
    -   **型態學**: 識別圖表中的特定價格模式（如頭肩頂、W底）。
-   **特點**: 應用廣泛，是許多系統化策略的基礎。

### 2. 因子分析 (Factor Analysis) / 多因子模型

-   **核心思想**: 資產的長期報酬可由一系列共同的「因子」解釋。
-   **方法**: 識別並投資於具有特定因子暴露的資產。
    -   **常見因子**: 價值 (Value), 動能 (Momentum), 規模 (Size), 品質 (Quality), 低波動 (Low Volatility)。
-   **特點**: 機構投資者主流方法，適用於中長期股票組合管理。

### 3. CTA (Commodity Trading Advisor) / 管理期貨策略

-   **核心思想**: 核心是 **趨勢跟蹤 (Trend Following)**，在市場呈現持續趨勢時順勢而為。
-   **方法**: 使用系統化規則（如移動平均線交叉）在各類期貨市場（股指、商品、外匯、債券）建立多頭或空頭部位。
-   **特點**:
    -   **跨資產類別**，分散化程度高。
    -   **危機 Alpha**，通常在市場大趨勢（無論漲跌）中表現良好。

### 4. 籌碼分析 (Flow/Chip Analysis)

-   **核心思想**: 分析不同市場參與者（法人、大戶、散戶）的資金流向與持倉分佈，判斷市場力量對比。
-   **方法**: 追蹤數據如三大法人買賣超、融資融券餘額、大戶持股比例等。
-   **特點**: 在資訊揭露相對透明的市場（如台股）特別受重視。

### 5. 統計套利 (Statistical Arbitrage / StatArb)

-   **核心思想**: 利用金融工具之間短期的統計關係（**均值回歸 Mean Reversion**）來獲利。
-   **方法**: 經典如 **配對交易 (Pairs Trading)**，買入相對低估的資產，賣出相對高估的資產，等待價差回歸。
-   **特點**: 通常為市場中性策略，持倉週期短，需要強大的統計建模能力。

### 6. 事件驅動 (Event-Driven)

-   **核心思想**: 專注於利用公司層面的特定事件（如併購、財報、重組）來創造投資機會。
-   **方法**: 深入分析事件對公司價值的影響，在價格完全反應前建立倉位。
-   **特點**: 高度依賴基本面分析和專業領域知識。

---

## 二、 機器學習在策略開發中的應用

機器學習本身不是一種交易策略，而是一套強大的 **方法論或工具集**。它可以應用於上述任何策略中，以提升效果、發現更複雜的模式或實現自動化。

### 1. 監督式學習 (Supervised Learning)

-   **核心思想**: 從帶有「正確答案」（標籤）的數據中學習輸入（特徵）與輸出（標籤）的關係。
-   **主要角色**: **預測**。
-   **詳細分類**:
    -   **分類 (Classification)**: 預測離散類別。例如：預測明日股價是「上漲」還是「下跌」。
    -   **迴歸 (Regression)**: 預測連續數值。例如：預測明日的具體報酬率或波動率。

### 2. 非監督式學習 (Unsupervised Learning)

-   **核心思想**: 從沒有「正確答案」的數據中自己發現內在的結構或模式。
-   **主要角色**: **理解市場、簡化數據**。
-   **詳細分類**:
    -   **分群 (Clustering)**: 將相似的數據歸為一類。例如：自動識別出「高波動上漲」、「低波動盤整」等不同的市場狀態 (Regime)。
    -   **降維 (Dimensionality Reduction)**: 壓縮特徵數據。例如：將50個相關的技術指標壓縮成5個無關的核心特徵，以提高模型的穩定性。

### 3. 強化學習 (Reinforcement Learning)

-   **核心思想**: 訓練一個「代理人(Agent)」在「環境(市場)」中通過「試錯」來學習，以最大化長期「獎勵(獲利)」。
-   **主要角色**: **直接決策**。
-   **策略範例**: 不做預測，而是直接學習一個最優的交易「策略(Policy)」，即在什麼市場狀態下，執行什麼動作（買/賣/持有）能獲得最高的長期回報。

# 第四章：開發交易策略 (Hands-on Part 2)

有了乾淨的數據，我們就可以開始最有趣的部分：建立一個交易策略。

### 4.1 策略開發的生命週期

一個嚴謹的量化策略開發，是一個不斷循環的科學過程：
1.  **觀察與假設:** 從數據或市場行為中觀察到一個現象，並形成一個可以被量化的假說。
2.  **特徵工程:** 根據假說，從原始數據中計算出新的數據欄位（特徵）。
3.  **訊號產生:** 根據特徵建立明確的買賣規則。
4.  **回測與驗證:** 在歷史數據上模擬交易，評估策略表現。
5.  **分析與修正:** 分析回測結果，回頭改進第一步的假設。

---

### 4.2 我們的第一個策略：均線交叉

- **觀察與假設 (Hypothesis):**
    我們觀察到價格似乎有趨勢性。一個常見的假設是：當近期價格的平均值（短期均線）超越長期價格的平均值（長期均線）時，可能代表一波上漲趨勢的開始。
    - **假說：** 當 20 分鐘均線由下往上穿越 60 分鐘均線時，做多；反之，則做空。這是一個典型的**趨勢跟隨 (Trend Following)** 策略。

- **特徵工程 (Feature Engineering):**
    我們的特徵就是「短期均線」和「長期均線」。
    ```python
    # 假設 df 是我們前一章節處理好的 DataFrame
    # 計算 20 分鐘和 60 分鐘的簡單移動平均線 (SMA)
    df['SMA20'] = df['Close'].rolling(window=20).mean()
    df['SMA60'] = df['Close'].rolling(window=60).mean()
    ```

- **訊號產生 (Signal Generation):**
    現在，我們要根據均線的相對位置，產生交易訊號 `1` (做多) 或 `-1` (做空/保持空手)。
    ```python
    import numpy as np

    # 當 SMA20 > SMA60 時，訊號為 1，否則為 -1
    df['signal'] = np.where(df['SMA20'] > df['SMA60'], 1, -1)
    
    # 觀察一下訊號的變化
    print(df[['Close', 'SMA20', 'SMA60', 'signal']].tail(10))
    ```

---

### 4.3 回測前的關鍵觀念：避免偷看未來 (Overfitting)

在我們用歷史數據測試策略之前，必須先建立一個極其重要的觀念：**數據劃分**。

如果我們用**全部**的歷史數據來開發策略，又用**同一份**數據來測試它，就像是拿著答案去寫考卷，得到的分數毫無意義。這會導致**過度擬合 (Overfitting)** — 我們的策略只是「背誦」了歷史數據的雜訊，而無法應對未來的真實市場。

為了得到更客觀的評估，我們會將數據切分為三份：

1.  **訓練期 (Training Set):** e.g., `2020-01-01` to `2022-12-31`
    - **用途：** 這是我們主要的「探索」區。我們用這段時間的數據來觀察現象、建立策略、選擇初步的參數（例如，為什麼是 20/60 均線，而不是 10/50？）。

2.  **驗證期 (Validation Set):** e.g., `2023-01-01` to `2023-12-31`
    - **用途：** 當你在訓練期找到了幾個看起來不錯的參數組合後，拿到驗證期來「比武」。驗證期就像是模擬考，你用它來確認你的策略或參數是否穩健，並從中挑選出最終版本。**這個階段你不能再回去修改策略的核心邏輯。**

3.  **測試期 (Testing Set / Out-of-Sample):** e.g., `2024-01-01` to `present`
    - **用途：** 這是最終的「大考」。你把你從驗證期脫穎而出的最終策略，應用在這段從未見過的數據上，**只跑一次**。這次的結果，才是對策略未來表現最真實的估計。跑完之後，無論結果好壞，都**不可以**再回頭去調整參數來迎合測試期的數據。

### 4.4 簡易回測實作

為了教學目的，我們暫時簡化流程，直接在整個數據集上進行回測。但在正式研究中，請務必遵守數據劃分的原則。

**核心邏輯：** 策略的報酬率 = 市場本身的報酬率 * 我們的持倉訊號

```python
# 為了避免「偷看未來」，我們的交易決策必須基於前一根 K 棒的訊號
# 所以我們將 signal 向後移動一格
df['signal'] = df['signal'].shift(1)

# 計算市場每分鐘的報酬率
df['market_returns'] = df['Close'].pct_change()

# 策略的報酬率 = 市場報酬率 * 持倉訊號
# （信號為 1 時，持有部位，賺取市場報酬；信號為 -1 時，放空部位，賺取反向報酬）
df['strategy_returns'] = df['market_returns'] * df['signal']

# 計算累積報酬率 (假設初始資金為 1)
df['cumulative_market_returns'] = (1 + df['market_returns']).cumprod()
df['cumulative_strategy_returns'] = (1 + df['strategy_returns']).cumprod()

# 繪製權益曲線圖
df[['cumulative_market_returns', 'cumulative_strategy_returns']].plot(
    figsize=(15, 8),
    title='Equity Curve: MA Crossover vs. Buy & Hold'
)
plt.show()
``` 